#!/bin/bash
# ContentMind Platform - Pre-Commit Hook
# ä»£ç æäº¤å‰è´¨é‡æ£€æŸ¥è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ğŸ” ContentMind Platform - ä»£ç æäº¤å‰æ£€æŸ¥å¼€å§‹..."
echo "=============================================="

# æ£€æŸ¥æ˜¯å¦æœ‰å¾…æäº¤çš„Javaæ–‡ä»¶
JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(java)$' || true)

if [ -z "$JAVA_FILES" ]; then
    echo "â„¹ï¸  æ²¡æœ‰Javaæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ£€æŸ¥"
    exit 0
fi

echo "ğŸ“ å‘ç°ä»¥ä¸‹Javaæ–‡ä»¶å˜æ›´:"
echo "$JAVA_FILES"
echo ""

# 1. ä»£ç æ ¼å¼æ£€æŸ¥
echo "ğŸ¨ [1/4] æ£€æŸ¥ä»£ç æ ¼å¼è§„èŒƒ..."
if mvn spotless:check -q; then
    echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
else
    echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼"
    echo "ğŸ’¡ è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š"
    echo "   mvn spotless:apply"
    exit 1
fi
echo ""

# 2. å•å…ƒæµ‹è¯•
echo "ğŸ§ª [2/4] è¿è¡Œå•å…ƒæµ‹è¯•..."
if mvn test -Dtest="!*IntegrationTest" -q; then
    echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
else
    echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥ï¼"
    echo "ğŸ’¡ è¯·æ£€æŸ¥æµ‹è¯•ä»£ç å¹¶ä¿®å¤å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹"
    exit 1
fi
echo ""

# 3. é™æ€ä»£ç åˆ†æ
echo "ğŸ” [3/4] é™æ€ä»£ç åˆ†æ..."
if mvn spotbugs:check -q; then
    echo "âœ… é™æ€ä»£ç åˆ†æé€šè¿‡"
else
    echo "âŒ å‘ç°ä»£ç è´¨é‡é—®é¢˜ï¼"
    echo "ğŸ’¡ è¯·æŸ¥çœ‹target/spotbugsXml.xmlæŠ¥å‘Šå¹¶ä¿®å¤é—®é¢˜"
    exit 1
fi
echo ""

# 4. æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
echo "ğŸ“Š [4/4] æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡..."
if mvn jacoco:check -q; then
    echo "âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡"
else
    echo "âŒ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³80%ï¼"
    echo "ğŸ’¡ è¯·å¢åŠ æµ‹è¯•ç”¨ä¾‹æé«˜ä»£ç è¦†ç›–ç‡"
    exit 1
fi
echo ""

# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ (Conventional Commits)
COMMIT_MSG_FILE=$1
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
    if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+"; then
        echo "âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸ç¬¦åˆConventional Commitsè§„èŒƒï¼"
        echo "ğŸ’¡ æ ¼å¼ç¤ºä¾‹ï¼š"
        echo "   feat(user): add user registration feature"
        echo "   fix(auth): resolve JWT token validation issue"
        echo "   docs(readme): update installation instructions"
        exit 1
    fi
fi

echo "=============================================="
echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ä»£ç å¯ä»¥æäº¤"
echo "â±ï¸  æ£€æŸ¥è€—æ—¶: $(date +'%Y-%m-%d %H:%M:%S')"
echo ""

exit 0